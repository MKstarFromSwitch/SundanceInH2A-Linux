#!/bin/bash

set -e

BUILD_ROOT=build/$1

source $1/env

mkdir -p $BUILD_ROOT

xcrun --sdk iphoneos clang \
    -arch armv7 \
    -mcpu=cortex-a8 \
    -mthumb \
    -Os \
    -Wl,-preload \
    -Wl,-segalign,0x4 \
    -nostdlib \
    -static \
    -DSTAGE2_BASE=$TARGET_STAGE2_BASE \
    -include $TARGET_CONFIG \
    stage1.S \
    -o $BUILD_ROOT/stage1.o
vmacho -f $BUILD_ROOT/stage1.o $BUILD_ROOT/stage1.bin

xcrun --sdk iphoneos clang \
    -arch armv7 \
    -mcpu=cortex-a8 \
    -mthumb \
    -Os \
    -Wl,-preload \
    -Wl,-segalign,0x4 \
    -Wl,-image_base,$TARGET_STAGE2_BASE \
    -nostdlib \
    -static \
    -Wl,-order_file,symorder.txt \
    -e _start \
    -DSTAGE2_BASE=$TARGET_STAGE2_BASE \
    -include $TARGET_CONFIG \
    stage2.c heap_repair.c \
    -o $BUILD_ROOT/stage2.o
vmacho -f $BUILD_ROOT/stage2.o $BUILD_ROOT/stage2.bin
